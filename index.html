<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Crypto Signals: BTC • BCH • TRX</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 0; 
            padding: 10px; 
            background: #f0f0f0; 
            display: flex; 
            flex-direction: column; 
        }
        h1 { text-align: center; font-size: 1.6em; margin: 10px 0; }
        h1 small { display: block; font-size: 0.7em; color: #666; }
        p { text-align: center; margin: 8px 0; font-size: 0.9em; }
        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin: 10px 0; 
            font-size: 0.9em; 
            table-layout: fixed;
        }
        th, td { 
            border: 1px solid #ccc; 
            padding: 8px; 
            text-align: center; 
            word-wrap: break-word;
        }
        th { background: #ddd; font-size: 0.8em; }
        .buy { background: #d4edda; color: #155724; }
        .sell { background: #f8d7da; color: #721c24; }
        .neutral { background: #fff3cd; color: #856404; }
        .action-btn {
            padding: 12px;
            font-size: 1.1em;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            text-decoration: none;
            display: block;
            width: 90%;
            margin: 8px auto;
        }
        .buy-btn { background: #28a745; color: white; }
        .sell-btn { background: #dc3545; color: white; }
        #charts { margin-top: 20px; }
        .chart-container {
            position: relative;
            height: 250px; /* Fixed height to prevent eating page */
            width: 100%;
            margin-bottom: 30px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        canvas { 
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
        }
        h2 { text-align: center; font-size: 1.2em; margin: 10px 0 5px; }
        @media (min-width: 600px) {
            th, td { padding: 12px; font-size: 1em; }
            .action-btn { width: 70%; font-size: 1.2em; }
            h1 { font-size: 2em; }
            .chart-container { height: 300px; }
        }
    </style>
</head>
<body>
    <h1>Crypto Signals<br><small>BTC • BCH • TRX</small></h1>
    <p>Last updated: <span id="last-update"></span></p>
    <p><strong>Tap BUY/SELL → opens OKX App directly to spot trading page</strong></p>

    <table id="signals-table">
        <thead>
            <tr>
                <th>Token</th>
                <th>Price USD</th>
                <th>MA Signal</th>
                <th>RSI Signal</th>
                <th>Suggestion</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <div id="charts"></div>

    <script>
        const tokens = [
            { name: 'BTC', id: 'bitcoin', pair: 'btc-usdt' },
            { name: 'BCH', id: 'bitcoin-cash', pair: 'bch-usdt' },
            { name: 'TRX', id: 'tron', pair: 'trx-usdt' }
        ];

        function openOKXSpotTrading(pair) {
            const tradeUrl = `https://www.okx.com/trade-spot/${pair}`;
            const encodedTradeUrl = encodeURIComponent(tradeUrl);
            const deepLink = `okx://wallet/dapp/url?dappUrl=${encodedTradeUrl}`;
            const universalLink = `https://www.okx.com/download?deeplink=${encodeURIComponent(deepLink)}`;

            window.location.href = universalLink;

            // Fallback to download page if app not opened
            setTimeout(() => {
                window.location.href = 'https://www.okx.com/download';
            }, 1500);
        }

        function calculateSMA(prices, period) {
            const sma = [];
            for (let i = 0; i < prices.length; i++) {
                if (i < period - 1) sma.push(null);
                else {
                    let sum = 0;
                    for (let j = 0; j < period; j++) sum += prices[i - j];
                    sma.push(sum / period);
                }
            }
            return sma;
        }

        function calculateRSI(prices, period = 14) {
            let gains = [], losses = [];
            for (let i = 1; i < prices.length; i++) {
                let diff = prices[i] - prices[i - 1];
                gains.push(diff > 0 ? diff : 0);
                losses.push(diff < 0 ? -diff : 0);
            }
            let avgGain = gains.slice(0, period).reduce((a, b) => a + b, 0) / period;
            let avgLoss = losses.slice(0, period).reduce((a, b) => a + b, 0) / period;
            let rsi = [null];
            for (let i = period; i < prices.length; i++) {
                avgGain = (avgGain * (period - 1) + gains[i]) / period;
                avgLoss = (avgLoss * (period - 1) + losses[i]) / period;
                if (avgLoss === 0) rsi.push(100);
                else {
                    let rs = avgGain / avgLoss;
                    rsi.push(100 - (100 / (1 + rs)));
                }
            }
            return rsi;
        }

        async function fetchData() {
            const tableBody = document.querySelector('#signals-table tbody');
            const chartsDiv = document.getElementById('charts');
            tableBody.innerHTML = '';
            chartsDiv.innerHTML = '';
            document.getElementById('last-update').textContent = new Date().toLocaleString();

            for (const token of tokens) {
                const priceRes = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${token.id}&vs_currencies=usd`);
                const priceData = await priceRes.json();
                const currentPrice = priceData[token.id].usd.toFixed(2);

                const histRes = await fetch(`https://api.coingecko.com/api/v3/coins/${token.id}/market_chart?vs_currency=usd&days=365`);
                const histData = await histRes.json();
                const prices = histData.prices.map(p => p[1]);

                const sma50 = calculateSMA(prices, 50);
                const sma200 = calculateSMA(prices, 200);
                const rsiValues = calculateRSI(prices, 14);

                const latestSMA50 = sma50[sma50.length - 1];
                const latestSMA200 = sma200[sma200.length - 1];
                const latestRSI = rsiValues[rsiValues.length - 1]?.toFixed(1) || 'N/A';

                let maSignal = 'Neutral', maClass = 'neutral';
                if (latestSMA50 > latestSMA200) { maSignal = 'Buy (Golden)'; maClass = 'buy'; }
                else if (latestSMA50 < latestSMA200) { maSignal = 'Sell (Death)'; maClass = 'sell'; }

                let rsiSignal = 'Neutral', rsiClass = 'neutral';
                if (latestRSI < 30) { rsiSignal = 'Buy (Oversold)'; rsiClass = 'buy'; }
                else if (latestRSI > 70) { rsiSignal = 'Sell (Overbought)'; rsiClass = 'sell'; }

                let combined = 'Hold';
                let actionHtml = '<strong>Hold</strong>';
                let actionClass = 'neutral';

                if (maClass === 'buy' && rsiClass === 'buy') { combined = 'Strong Buy'; actionClass = 'buy'; }
                else if (maClass === 'sell' && rsiClass === 'sell') { combined = 'Strong Sell'; actionClass = 'sell'; }
                else if (maClass === 'buy' || rsiClass === 'buy') { combined = 'Buy'; actionClass = 'buy'; }
                else if (maClass === 'sell' || rsiClass === 'sell') { combined = 'Sell'; actionClass = 'sell'; }

                if (actionClass === 'buy') {
                    actionHtml = `<a class="action-btn buy-btn" onclick="openOKXSpotTrading('${token.pair}'); return false;">BUY on OKX</a>`;
                } else if (actionClass === 'sell') {
                    actionHtml = `<a class="action-btn sell-btn" onclick="openOKXSpotTrading('${token.pair}'); return false;">SELL on OKX</a>`;
                }

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${token.name}</strong></td>
                    <td>$${currentPrice}</td>
                    <td class="${maClass}">${maSignal}</td>
                    <td class="${rsiClass}">${rsiSignal}<br>(RSI: ${latestRSI})</td>
                    <td><strong>${combined}</strong></td>
                    <td>${actionHtml}</td>
                `;
                tableBody.appendChild(row);

                // Chart with fixed container
                const chartWrapper = document.createElement('div');
                chartWrapper.innerHTML = `<h2>${token.name} - Last 365 Days</h2><div class="chart-container"><canvas id="chart-${token.name}"></canvas></div>`;
                chartsDiv.appendChild(chartWrapper);

                const ctx = document.getElementById(`chart-${token.name}`).getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: histData.prices.map((_, i) => i % 30 === 0 ? `Day ${i}` : ''),
                        datasets: [
                            { label: 'Price', data: prices, borderColor: '#007bff', fill: false, tension: 0.1 },
                            { label: '50 SMA', data: sma50, borderColor: '#fd7e14', fill: false },
                            { label: '200 SMA', data: sma200, borderColor: '#dc3545', fill: false }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { y: { beginAtZero: false } }
                    }
                });
            }
        }

        fetchData();
        setInterval(fetchData, 300000); // Refresh every 5 minutes
    </script>
</body>
</html>
