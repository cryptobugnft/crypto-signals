<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Signals: BTC • BCH • TRX</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 15px; background: #f0f0f0; }
        h1 { text-align: center; font-size: 1.8em; }
        p { text-align: center; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; font-size: 1em; }
        th, td { border: 1px solid #ccc; padding: 12px; text-align: center; }
        th { background: #ddd; }
        .buy { background: #d4edda; color: #155724; }
        .sell { background: #f8d7da; color: #721c24; }
        .neutral { background: #fff3cd; color: #856404; }
        .action-btn {
            padding: 14px 24px;
            font-size: 1.2em;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            text-decoration: none;
            display: block;
            width: 90%;
            margin: 10px auto;
        }
        .buy-btn { background: #28a745; color: white; }
        .sell-btn { background: #dc3545; color: white; }
        canvas { max-width: 100%; height: 300px; background: white; margin-top: 20px; border: 1px solid #ddd; border-radius: 8px; }
    </style>
</head>
<body>
    <h1>Crypto Signals<br><small>BTC • BCH • TRX</small></h1>
    <p>Last updated: <span id="last-update"></span></p>
    <p><strong>Tap BUY or SELL → opens OKX APP directly (even if website is blocked)</strong></p>

    <table id="signals-table">
        <thead>
            <tr>
                <th>Token</th>
                <th>Price (USD)</th>
                <th>MA Signal</th>
                <th>RSI Signal</th>
                <th>Suggestion</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <div id="charts"></div>

    <script>
        const tokens = [
            { name: 'BTC', id: 'bitcoin', pair: 'btc-usdt' },
            { name: 'BCH', id: 'bitcoin-cash', pair: 'bch-usdt' },
            { name: 'TRX', id: 'tron', pair: 'trx-usdt' }
        ];

        function openOKXApp(pair) {
            // Trading page URL on web
            const webUrl = `https://www.okx.com/trade-spot/${pair}`;
            
            // Encode it for deep link (OKX mobile detects trading pages and opens app)
            const encodedWebUrl = encodeURIComponent(webUrl);
            const deepLink = `okx://trade?url=${encodedWebUrl}`;
            
            // Universal fallback: redirects to app if installed, or download page if not
            const universalLink = `https://www.okx.com/download?deeplink=${encodeURIComponent(deepLink)}`;
            
            // Try to open app directly
            window.location.href = universalLink;
            
            // Fallback after 2 seconds (in case app not installed)
            setTimeout(() => {
                window.location.href = 'https://www.okx.com/download';
            }, 2000);
        }

        // Rest of your calculation functions (SMA, RSI) remain the same
        function calculateSMA(prices, period) {
            const sma = [];
            for (let i = 0; i < prices.length; i++) {
                if (i < period - 1) sma.push(null);
                else {
                    let sum = 0;
                    for (let j = 0; j < period; j++) sum += prices[i - j];
                    sma.push(sum / period);
                }
            }
            return sma;
        }

        function calculateRSI(prices, period = 14) {
            let gains = [], losses = [];
            for (let i = 1; i < prices.length; i++) {
                let diff = prices[i] - prices[i - 1];
                gains.push(diff > 0 ? diff : 0);
                losses.push(diff < 0 ? -diff : 0);
            }
            let avgGain = gains.slice(0, period).reduce((a, b) => a + b, 0) / period;
            let avgLoss = losses.slice(0, period).reduce((a, b) => a + b, 0) / period;
            let rsi = [null];
            for (let i = period; i < prices.length; i++) {
                avgGain = (avgGain * (period - 1) + gains[i]) / period;
                avgLoss = (avgLoss * (period - 1) + losses[i]) / period;
                if (avgLoss === 0) rsi.push(100);
                else {
                    let rs = avgGain / avgLoss;
                    rsi.push(100 - (100 / (1 + rs)));
                }
            }
            return rsi;
        }

        async function fetchData() {
            const tableBody = document.querySelector('#signals-table tbody');
            const chartsDiv = document.getElementById('charts');
            tableBody.innerHTML = '';
            chartsDiv.innerHTML = '';
            document.getElementById('last-update').textContent = new Date().toLocaleString();

            for (const token of tokens) {
                // Price & History fetch (same as before)
                const priceRes = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${token.id}&vs_currencies=usd`);
                const priceData = await priceRes.json();
                const currentPrice = priceData[token.id].usd.toFixed(2);

                const histRes = await fetch(`https://api.coingecko.com/api/v3/coins/${token.id}/market_chart?vs_currency=usd&days=365`);
                const histData = await histRes.json();
                const prices = histData.prices.map(p => p[1]);

                const sma50 = calculateSMA(prices, 50);
                const sma200 = calculateSMA(prices, 200);
                const rsiValues = calculateRSI(prices, 14);

                const latestSMA50 = sma50[sma50.length - 1];
                const latestSMA200 = sma200[sma200.length - 1];
                const latestRSI = rsiValues[rsiValues.length - 1]?.toFixed(1) || 'N/A';

                // Signals logic (same)
                let maSignal = 'Neutral', maClass = 'neutral';
                if (latestSMA50 > latestSMA200) { maSignal = 'Buy (Golden Cross)'; maClass = 'buy'; }
                else if (latestSMA50 < latestSMA200) { maSignal = 'Sell (Death Cross)'; maClass = 'sell'; }

                let rsiSignal = 'Neutral', rsiClass = 'neutral';
                if (latestRSI < 30) { rsiSignal = 'Buy (Oversold)'; rsiClass = 'buy'; }
                else if (latestRSI > 70) { rsiSignal = 'Sell (Overbought)'; rsiClass = 'sell'; }

                let combined = 'Hold';
                let actionHtml = '<strong>Hold</strong>';
                let actionClass = 'neutral';

                if (maClass === 'buy' && rsiClass === 'buy') { combined = 'Strong Buy'; actionClass = 'buy'; }
                else if (maClass === 'sell' && rsiClass === 'sell') { combined = 'Strong Sell'; actionClass = 'sell'; }
                else if (maClass === 'buy' || rsiClass === 'buy') { combined = 'Buy'; actionClass = 'buy'; }
                else if (maClass === 'sell' || rsiClass === 'sell') { combined = 'Sell'; actionClass = 'sell'; }

                if (actionClass === 'buy') {
                    actionHtml = `<a class="action-btn buy-btn" onclick="openOKXApp('${token.pair}'); return false;">BUY on OKX App</a>`;
                } else if (actionClass === 'sell') {
                    actionHtml = `<a class="action-btn sell-btn" onclick="openOKXApp('${token.pair}'); return false;">SELL on OKX App</a>`;
                }

                // Table row
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${token.name}</strong></td>
                    <td>$${currentPrice}</td>
                    <td class="${maClass}">${maSignal}</td>
                    <td class="${rsiClass}">${rsiSignal} (RSI: ${latestRSI})</td>
                    <td><strong>${combined}</strong></td>
                    <td>${actionHtml}</td>
                `;
                tableBody.appendChild(row);

                // Chart (same as before)
                const chartDiv = document.createElement('div');
                chartDiv.innerHTML = `<h2>${token.name} (365 days)</h2><canvas id="chart-${token.name}"></canvas>`;
                chartsDiv.appendChild(chartDiv);

                const ctx = document.getElementById(`chart-${token.name}`).getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: histData.prices.map((_, i) => i % 30 === 0 ? `Day ${i}` : ''),
                        datasets: [
                            { label: 'Price', data: prices, borderColor: '#007bff', fill: false },
                            { label: '50 SMA', data: sma50, borderColor: '#fd7e14', fill: false },
                            { label: '200 SMA', data: sma200, borderColor: '#dc3545', fill: false }
                        ]
                    },
                    options: { responsive: true }
                });
            }
        }

        fetchData();
        setInterval(fetchData, 300000); // 5 minutes
    </script>
</body>
</html>
