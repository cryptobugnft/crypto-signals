<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Crypto Signals Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg: #0f172a;
            --card-bg: #1e293b;
            --text: #e2e8f0;
            --text-muted: #94a3b8;
            --accent: #3b82f6;
            --green: #10b981;
            --red: #ef4444;
        }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            padding: 10px; 
            background: var(--bg); 
            color: var(--text);
        }
        h1 { text-align: center; font-size: 1.8em; margin: 15px 0; }
        p { text-align: center; margin: 8px 0; font-size: 0.95em; color: var(--text-muted); }
        #search-container { text-align: center; margin: 15px 0; }
        #search-input { padding: 10px; width: 70%; max-width: 300px; border: 1px solid #334155; background: var(--card-bg); color: var(--text); border-radius: 8px; }
        #add-favorite { padding: 10px 18px; background: var(--accent); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        #top-table { width: 100%; border-collapse: separate; border-spacing: 0; margin: 20px 0; background: var(--card-bg); border-radius: 12px; overflow: hidden; box-shadow: 0 8px 25px rgba(0,0,0,0.4); }
        #top-table th { background: #16213a; padding: 14px; font-size: 0.9em; color: var(--text-muted); }
        #top-table td { padding: 12px; text-align: center; border-bottom: 1px solid #334155; }
        .token-info { display: flex; align-items: center; justify-content: center; gap: 12px; }
        .token-icon { width: 36px; height: 36px; border-radius: 50%; }
        .token-symbol { font-weight: bold; font-size: 1.1em; }
        .token-name { color: var(--text-muted); font-size: 0.9em; }
        .mini-chart-container { height: 60px; width: 130px; margin: 0 auto; }
        .price-cell { font-size: 1.2em; font-weight: bold; }
        .arrow { font-size: 1.4em; margin-left: 8px; }
        .green { color: var(--green); }
        .red { color: var(--red); }
        #token-list { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin: 20px 0; }
        .token-btn { padding: 10px 20px; background: var(--card-bg); border: 1px solid #334155; border-radius: 8px; color: var(--text); cursor: pointer; }
        .token-btn:hover { background: #334155; }
        .token-btn.selected { background: var(--accent); border-color: var(--accent); }
        #content { background: var(--card-bg); padding: 20px; border-radius: 12px; box-shadow: 0 8px 25px rgba(0,0,0,0.4); margin-top: 20px; display: none; }
        #tabs { display: flex; margin-bottom: 20px; border-bottom: 1px solid #334155; }
        .tab-btn { flex: 1; padding: 14px; background: none; border: none; color: var(--text-muted); font-size: 1em; cursor: pointer; }
        .tab-btn.active { color: var(--text); border-bottom: 3px solid var(--accent); font-weight: bold; }
        .action-btn { padding: 14px; font-size: 1.1em; border-radius: 8px; cursor: pointer; display: block; width: 90%; margin: 15px auto; text-decoration: none; color: white; text-align: center; font-weight: bold; }
        .buy-btn { background: var(--green); }
        .sell-btn { background: var(--red); }
        .chart-container { position: relative; height: 300px; margin: 20px 0; }
        .news-item { margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid #334155; }
        .news-item a { color: var(--accent); text-decoration: none; font-size: 1.05em; }
        .news-item a:hover { text-decoration: underline; }
        .news-item small { color: var(--text-muted); }
        @media (min-width: 768px) {
            #content { max-width: 900px; margin: 30px auto; }
        }
    </style>
</head>
<body>
    <h1>Crypto Signals Pro</h1>
    <p>Top 10 by Market Cap + Favorites | Updated: <span id="last-update"></span></p>
    
    <div id="search-container">
        <input id="search-input" type="text" placeholder="Search any token (e.g., solana, pepe)">
        <button id="add-favorite">Add Favorite</button>
    </div>
    
    <table id="top-table">
        <thead>
            <tr>
                <th>Icon</th>
                <th>Token</th>
                <th>Trend (7d)</th>
                <th>Price (USD)</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
    
    <div id="token-list"></div>
    
    <div id="content">
        <div id="tabs">
            <button class="tab-btn active" data-tab="overview">Overview</button>
            <button class="tab-btn" data-tab="community">Community</button>
            <button class="tab-btn" data-tab="about">About</button>
        </div>
        <div id="overview" class="tab-content"></div>
        <div id="community" class="tab-content" style="display: none;"></div>
        <div id="about" class="tab-content" style="display: none;"></div>
    </div>

    <script>
        const CRYPTOPANIC_TOKEN = '1c5d36d83941f66b7c828ee52b1017ea4e019f9f';
        let selectedToken = null;
        let favorites = JSON.parse(localStorage.getItem('cryptoFavorites') || '[]');
        let topTokens = [];
        let chartInstance = null;

        async function fetchTopTokens() {
            try {
                const res = await fetch('https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=10&page=1&sparkline=true&price_change_percentage=24h');
                if (!res.ok) throw new Error('Rate limited');
                const data = await res.json();
                topTokens = data.map(coin => ({
                    id: coin.id,
                    name: coin.name,
                    symbol: coin.symbol.toUpperCase(),
                    image: coin.image,
                    price: coin.current_price,
                    change24h: coin.price_change_percentage_24h,
                    sparkline: coin.sparkline_in_7d.price
                }));
                renderTopTable();
                renderTokenList();
                document.getElementById('last-update').textContent = new Date().toLocaleString();
            } catch (e) {
                document.querySelector('#top-table tbody').innerHTML = '<tr><td colspan="4">Loading top tokens... (rate limited, retrying soon)</td></tr>';
            }
        }

        function renderTopTable() {
            const tbody = document.querySelector('#top-table tbody');
            tbody.innerHTML = '';
            topTokens.forEach(token => {
                const isUp = token.change24h > 0;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><img class="token-icon" src="${token.image}" alt="${token.symbol}"></td>
                    <td class="token-info">
                        <div>
                            <div class="token-symbol">${token.symbol}</div>
                            <div class="token-name">${token.name}</div>
                        </div>
                    </td>
                    <td><div class="mini-chart-container"><canvas id="mini-${token.id}"></canvas></div></td>
                    <td class="price-cell">
                        $${token.price.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 6})}
                        <span class="arrow ${isUp ? 'green' : 'red'}">${isUp ? '↑' : '↓'}</span>
                    </td>
                `;
                tbody.appendChild(row);

                const ctx = document.getElementById(`mini-${token.id}`).getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        datasets: [{
                            data: token.sparkline,
                            borderColor: isUp ? 'rgb(16,185,129)' : 'rgb(239,68,68)',
                            backgroundColor: 'transparent',
                            tension: 0.4,
                            pointRadius: 0,
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { x: { display: false }, y: { display: false } },
                        plugins: { legend: { display: false }, tooltip: { enabled: false } }
                    }
                });
            });
        }

        function renderTokenList() {
            const list = document.getElementById('token-list');
            list.innerHTML = '<strong style="width:100%; text-align:center; color:#94a3b8;">Your Favorites:</strong>';
            if (favorites.length === 0) {
                list.innerHTML += '<p style="color:#64748b;">No favorites yet. Search and add!</p>';
            }
            favorites.forEach(id => {
                if (!topTokens.some(t => t.id === id)) {
                    const btn = document.createElement('button');
                    btn.className = 'token-btn';
                    btn.textContent = id.charAt(0).toUpperCase() + id.slice(1);
                    btn.dataset.id = id;
                    btn.onclick = () => selectToken({ id });
                    list.appendChild(btn);
                }
            });
        }

        async function selectToken(token) {
            selectedToken = token;
            document.querySelectorAll('.token-btn').forEach(b => b.classList.remove('selected'));
            const btn = document.querySelector(`[data-id="${token.id}"]`);
            if (btn) btn.classList.add('selected');
            document.getElementById('content').style.display = 'block';
            await loadOverview(token);
            await loadCommunity(token);
            await loadAbout(token);
            showTab('overview');
        }

        function showTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
            document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
            document.getElementById(tab).style.display = 'block';
        }

        // ... (loadOverview, loadCommunity, loadAbout, searchToken, openOKXSpotTrading, calculateSMA/RSI same as previous working version)

        // Paste these functions from the last working version (they are unchanged)
        // For brevity, including only key parts — but in your file, keep them all

        async function loadOverview(token) {
            // Same as before — fetches 365 days only once when selected
            // Uses calculateSMA/RSI and displays full chart + signals + OKX button
        }

        // ... include all other functions (calculateSMA, calculateRSI, openOKXSpotTrading, etc.)

        document.getElementById('add-favorite').onclick = () => {
            const query = document.getElementById('search-input').value.trim();
            if (query) searchToken(query);
        };

        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.onclick = () => showTab(btn.dataset.tab);
        });

        // Initial load
        fetchTopTokens();
        setInterval(fetchTopTokens, 300000); // Refresh every 5 min
    </script>
</body>
</html>
